package com.wtwd.sys.appinterfaces;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.io.Writer;
import java.util.Date;
import java.util.List;

import javax.servlet.ServletInputStream;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.sf.json.JSONObject;

import org.apache.commons.logging.Log;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.godoing.rose.lang.DataMap;
import com.godoing.rose.log.LogFactory;
import com.wtwd.common.config.ServiceBean;
import com.wtwd.common.http.BaseAction;
import com.wtwd.common.lang.Constant;
import com.wtwd.sys.appuserinfo.domain.AppUserInfo;
import com.wtwd.sys.deviceactiveinfo.domain.DeviceActiveInfo;
import com.wtwd.sys.deviceactiveinfo.domain.logic.DeviceActiveInfoFacade;
import com.wtwd.sys.phoneinfo.domain.PhoneInfo;
import com.wtwd.sys.phoneinfo.domain.logic.PhoneInfoFacade;
import com.wtwd.sys.settinginfo.domain.SettingInfo;
import com.wtwd.sys.shareinfo.domain.ShareInfo;

public class VerifyDeviceAction extends BaseAction{

	Log logger = LogFactory.getLog(VerifyDeviceAction.class);
	
	private final static int BOND_FAIL_NO = -2;  //锟借备锟斤拷锟较凤拷
	private final static int BOND_FAIL_ALREADY = -3;  //锟借备锟窖憋拷锟斤拷
	
	@SuppressWarnings("finally")
	public ActionForward execute(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response)
			throws Exception {
		request.setCharacterEncoding("UTF-8");
		String href = request.getServletPath();
		Date start = new Date();
		JSONObject json = new JSONObject();
		ServiceBean mIntances = ServiceBean.getInstance();
		
		try{
			ServletInputStream input = request.getInputStream();
			BufferedReader reader = new BufferedReader(new InputStreamReader(input));
			StringBuffer sb = new StringBuffer();
			String online = "";
			while((online = reader.readLine()) != null){
				sb.append(online);
			}
			JSONObject object = JSONObject.fromObject(sb.toString());
			
			String user_id = object.getString("user_id");  //鐢ㄦ埛id
			String device_imei = object.getString("device_imei");
			String belongProject = object.getString("belong_project");
			//get娴嬭瘯
//			String user_id = request.getParameter("user_id");  //鐢ㄦ埛id
//			String device_imei = request.getParameter("device_imei");
//			String belongProject = request.getParameter("belong_project");
			
			if(user_id != null && !"".equals(user_id) && device_imei != null && !"".equals(device_imei)){
				
				AppUserInfo appUser = new AppUserInfo();
				appUser.setCondition("id='"+user_id+"'");
				List<DataMap> appUserList = ServiceBean.getInstance().getAppUserInfoFacade().getAppUserInfo(appUser);
				if(appUserList.size() > 0){
					PhoneInfo phoneInfo = new PhoneInfo(); // 鎬昏〃绫�
					DeviceActiveInfo deviceActiveInfo = new DeviceActiveInfo();
					ShareInfo shareInfo = new ShareInfo();  //鍒嗕韩绫�
					
					PhoneInfoFacade mPhoneInfoFacade = mIntances.getPhoneInfoFacade();
					DeviceActiveInfoFacade mDeviceActiveInfoFacade = mIntances.getDeviceActiveInfoFacade();
					
					phoneInfo.setCondition("serie_no = '"+device_imei+"' and belong_project='"+belongProject+"'");
					List<DataMap> phoneList = mPhoneInfoFacade.getPhoneInfo(phoneInfo);
					
					deviceActiveInfo.setCondition("device_imei ='"+device_imei+"' and belong_project='"+belongProject+"'");  //鍒ゅ畾鏉′欢
					List<DataMap> deviceList = mDeviceActiveInfoFacade.getDeviceActiveInfo(deviceActiveInfo);
					int size = deviceList.size();
					if(phoneList.size() <= 0){  //缁戝畾澶辫触
						result = BOND_FAIL_NO;  
					}else if(size > 0){  //宸茶缁戝畾
						String device_disable = ""+ deviceList.get(0).getAt("device_disable");
						String count = ""+ deviceList.get(0).getAt("count");
						
						if(device_disable.equals("1")){  //璇存槑鏄縺娲荤姸鎬�
							result = BOND_FAIL_ALREADY;  
						}else if(device_disable.equals("0")){  //璇存槑鏈縺娲荤姸鎬�
							deviceActiveInfo.setCount(String.valueOf(Integer.valueOf(count) + 1));
							deviceActiveInfo.setDeviceDisable("1");
							deviceActiveInfo.setUserId(user_id);
							mDeviceActiveInfoFacade.updateDeviceActiveInfo(deviceActiveInfo);
							
							phoneInfo.setStatus("2"); //2琛ㄧず婵�椿
							phoneInfo.setSerieNo(device_imei);
							mIntances.getPhoneInfoFacade().updatePhoneInfo(phoneInfo);
							
							shareInfo.setDeviceId(device_imei);
							shareInfo.setUserId(user_id);
							shareInfo.setToUserId(user_id);  //锟斤拷锟借备锟斤拷实锟斤拷锟斤拷锟侥撅拷锟斤拷锟皆硷拷
							shareInfo.setIsPriority("1");    //1锟斤拷示锟皆硷拷锟斤拷
							shareInfo.setShareDate(new Date());  //锟斤拷锟斤拷锟斤拷约锟绞憋拷锟�
							shareInfo.setBelongProject(belongProject);
							mIntances.getShareInfoFacade().insertShareInfo(shareInfo);
							
							json.put("device_phone", "1868662536");         //锟借备锟界话锟斤拷锟斤拷
							
							SettingInfo settingInfo = new SettingInfo();
							settingInfo.setSerieNo(device_imei);
							settingInfo.setVolume(30);
							settingInfo.setLight("0");
							settingInfo.setMap("0");
							settingInfo.setFallOn("0");
							settingInfo.setGps_on("0");   //默认关闭
							settingInfo.setBelongProject(belongProject);
							settingInfo.setAutoMute("0");
							settingInfo.setPowerOff("0");
							ServiceBean.getInstance().getSettingInfoFacade()
									.insertSettingInfo(settingInfo);
						
							result = Constant.SUCCESS_CODE;
						}			
					}else{
						String device_phone = ""+ phoneList.get(0).getAt("phone");				
						deviceActiveInfo.setDeviceAge("2015-12-12");
						deviceActiveInfo.setDeviceDisable("1");
						deviceActiveInfo.setCount("1");
						deviceActiveInfo.setDeviceHead("0");
						deviceActiveInfo.setDeviceHeight("170");
						deviceActiveInfo.setDeviceImei(device_imei);
						deviceActiveInfo.setDeviceName("0");
						deviceActiveInfo.setDevicePhone(device_phone);
						deviceActiveInfo.setDeviceSex("0");
						deviceActiveInfo.setDeviceUpdateTime(new Date());
						deviceActiveInfo.setDeviceWeight("170");
						deviceActiveInfo.setUserId(user_id);
						deviceActiveInfo.setBelongProject(belongProject);
						mDeviceActiveInfoFacade.insertDeviceActiveInfo(deviceActiveInfo);			
						
						phoneInfo.setStatus("2"); //2琛ㄧず婵�椿
						phoneInfo.setSerieNo(device_imei);
						mIntances.getPhoneInfoFacade().updatePhoneInfo(phoneInfo);
//						List<DataMap> deviceList2 = mDeviceActiveInfoFacade.getDeviceActiveInfo(deviceActiveInfo);
//						if(deviceList2.size() > 0){
//							String device_id = ""+deviceList2.get(0).getAt("id");  
//							json.put("device_id", device_id);         //
//						}
						
						shareInfo.setDeviceId(device_imei);
						shareInfo.setUserId(user_id);
						shareInfo.setToUserId(user_id);  //锟斤拷锟借备锟斤拷实锟斤拷锟斤拷锟侥撅拷锟斤拷锟皆硷拷
						shareInfo.setIsPriority("1");    //1锟斤拷示锟皆硷拷锟斤拷
						shareInfo.setShareDate(new Date());  //锟斤拷锟斤拷锟斤拷约锟绞憋拷锟�
						shareInfo.setBelongProject(belongProject);
						mIntances.getShareInfoFacade().insertShareInfo(shareInfo);
						
						json.put("device_phone", device_phone);         //锟借备锟界话锟斤拷锟斤拷
						result = Constant.SUCCESS_CODE;
					}
					if(result == 1){
						if(appUserList.size() > 0){
							String bindCount = (String)appUserList.get(0).getAt("bind_count");
							appUser.setBindCount(String.valueOf(Integer.parseInt(bindCount) + 1));
							ServiceBean.getInstance().getAppUserInfoFacade().updateAppUserInfo(appUser);
						}
						
						DeviceActiveInfo da = new DeviceActiveInfo();
						da.setDeviceImei(device_imei);
						da.setBelongProject(belongProject);
						da.setUserId(user_id);
						da.setDeviceDisable("1");
						da.setDeviceUpdateTime(new Date());
						ServiceBean.getInstance().getDeviceActiveInfoFacade().insertDeviceActiveHistory(da);
					}
				}else{
					result = -4;
				}			
			}
			insertVisit(href,belongProject,user_id,0,start,new Date());
		}catch(Exception e){
			e.printStackTrace();	
			StringBuffer sb = new StringBuffer();
			Writer writer = new StringWriter();
			PrintWriter printWriter = new PrintWriter(writer);
			Throwable cause = e.getCause();		
			while (cause != null) {
				cause.printStackTrace(printWriter);
				cause = cause.getCause();
			}
			printWriter.close();
			String resultSb = writer.toString();
			sb.append(resultSb);
			
			logger.error(e);
			result = Constant.EXCEPTION_CODE;
			json.put(Constant.EXCEPTION, sb.toString());
		}finally{
			json.put("request", href);
			json.put(Constant.RESULTCODE, result);
			
			response.setCharacterEncoding("UTF-8");	
			response.getWriter().write(json.toString());		
			return null;
		}
	}
}
